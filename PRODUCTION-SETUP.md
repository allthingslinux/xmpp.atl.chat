# Production Deployment Guide

This guide covers setting up the XMPP server for production use.

## Prerequisites

1. **Domain Name**: You need a domain (e.g., `atl.chat`) with DNS management
2. **Cloudflare Account**: For DNS-01 SSL certificate challenges
3. **Server**: Ubuntu/Debian server with Docker and Docker Compose installed

## DNS Configuration

Configure these DNS records for your domain:

```
# Main XMPP server
xmpp.yourdomain.com     A      YOUR_SERVER_IP

# MUC (Multi-User Chat) - optional
muc.yourdomain.com      A      YOUR_SERVER_IP

# File Upload service
upload.yourdomain.com   A      YOUR_SERVER_IP

# TURN/STUN for audio/video
turn.yourdomain.com     A      YOUR_SERVER_IP

# Main domain for service discovery
yourdomain.com          A      YOUR_SERVER_IP
*.yourdomain.com        A      YOUR_SERVER_IP
```

## SSL Certificates

The setup uses Let's Encrypt with Cloudflare DNS-01 challenge for wildcard certificates.

## Production Setup Steps

### 1. Clone the Repository

```bash
git clone <your-repo-url>
cd xmpp-server
```

### 2. Set Up Secrets

Run the interactive secrets setup script:

```bash
./scripts/setup-production-secrets.sh
```

This will prompt you for:
- Cloudflare email and API key
- Generate secure passwords for database and admin accounts

### 3. Review Configuration

Check that `.env.production` contains the correct domain settings:

```bash
# Should be your actual domain
PROSODY_DOMAIN=yourdomain.com
```

### 4. Start Services

```bash
# Start all services using the production configuration
docker compose up -d

# The compose file automatically loads both:
# - .env.production (main config, committed to git)
# - .env.production.local (secrets, not committed to git)
```

#### How Environment Loading Works

Docker Compose automatically loads environment files in this order:

1. **`.env.production`** - Main configuration (committed to git)
   - Contains non-sensitive settings like domain names, ports, feature flags
   - Safe to commit to version control

2. **`.env.production.local`** - Secrets and local overrides (NOT committed to git)
   - Contains passwords, API keys, and sensitive data
   - Generated by `setup-production-secrets.sh`
   - Automatically ignored by `.gitignore`

Variables in `.env.production.local` override those in `.env.production`, allowing you to keep secrets separate from configuration.

### 5. Set Up SSL Certificates

```bash
# Generate SSL certificates using Cloudflare DNS challenge
docker compose --env-file .env.production.local run --rm xmpp-certbot

# Set up auto-renewal (runs daily)
docker compose --env-file .env.production.local up -d xmpp-certbot-renew
```

### 6. Verify Installation

```bash
# Check that all services are running
docker compose ps

# Check logs for any issues
docker compose logs xmpp-prosody
docker compose logs xmpp-nginx

# Test XMPP connection
docker exec xmpp-prosody prosodyctl status
```

## Security Notes

- **Never commit secrets** to git (they're in `.env.production.local`)
- **Keep certificates secure** - they're in `.runtime/certs/`
- **Regular backups** - Database and configuration
- **Monitor logs** - Check for security issues regularly

## File Structure

```
.env.production          # Non-sensitive config (committed to git)
.env.production.local    # Secrets (NOT committed to git)
.runtime/               # Runtime data (NOT committed to git)
  ├── certs/           # SSL certificates
  ├── logs/            # Application logs
  ├── turn/            # TURN server config
  └── cloudflare-credentials.ini
```

## Troubleshooting

### SSL Certificate Issues

If certificates fail to generate:
1. Check Cloudflare credentials are correct
2. Ensure DNS records are properly configured
3. Check that ports 80/443 are accessible from the internet

### Database Connection Issues

```bash
# Check database logs
docker compose logs xmpp-postgres

# Test database connection
docker exec xmpp-postgres pg_isready -U prosody
```

### XMPP Connection Issues

```bash
# Check Prosody logs
docker compose logs xmpp-prosody

# Test XMPP connectivity
docker exec xmpp-prosody prosodyctl status

# Check firewall rules
sudo ufw status
```

## Monitoring

The server includes several monitoring endpoints:

- **Prometheus metrics**: `https://xmpp.yourdomain.com/metrics`
- **Nginx status**: `https://xmpp.yourdomain.com/nginx-status`
- **Prosody status**: `https://xmpp.yourdomain.com/status`

## Backup Strategy

Set up regular backups of:
- PostgreSQL database
- SSL certificates (`.runtime/certs/`)
- Configuration files
- Docker volumes

Example backup script:
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/backups/xmpp"

# Database backup
docker exec xmpp-postgres pg_dumpall -U prosody > $BACKUP_DIR/db_$DATE.sql

# Config backup
tar -czf $BACKUP_DIR/config_$DATE.tar.gz .env.production.local .runtime/
```
